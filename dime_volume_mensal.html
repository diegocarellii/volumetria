<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processamento de Volume por Categoria</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin-top: 30px;
        }

        .table-container {
            margin-top: 20px;
        }

        .month-card {
            margin-bottom: 20px;
        }

        .chart-container {
            margin-top: 20px;
            width: 100%;
        }

        .ajuste-input {
            width: 80px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <div class="container">
        <h2 class="mb-4">Processamento de Volume por Categoria</h2>
        <div class="card p-4 mb-4">
            <div class="mb-3">
                <label for="totalVolume" class="form-label">Volume Total do Mês:</label>
                <input type="number" class="form-control" id="totalVolume" placeholder="Digite o volume total">
            </div>
            <div class="mb-3">
                <label for="excelFile" class="form-label">Carregar Arquivo Excel:</label>
                <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls">
            </div>
            <button class="btn btn-primary" onclick="processData()">Processar Dados</button>
        </div>

        <div class="row month-card" id="monthCards" style="display: none;">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" id="cardMonth1">Mês 1</h5>
                        <p class="card-text">Total Volume: <span id="totalMonth1">0</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" id="cardMonth2">Mês 2</h5>
                        <p class="card-text">Total Volume: <span id="totalMonth2">0</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" id="cardMonth3">Mês 3</h5>
                        <p class="card-text">Total Volume: <span id="totalMonth3">0</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="percentChart" style="display: none;"></canvas>
        </div>

        <div class="table-container">
            <table id="resultTable" class="table table-striped table-bordered" style="display: none;">
                <thead class="table-light">
                    <tr>
                        <th>Categoria</th>
                        <th id="month1">Mês 1</th>
                        <th id="month2">Mês 2</th>
                        <th id="month3">Mês 3</th>
                        <th id="percent1">% Mês 1</th>
                        <th id="percent2">% Mês 2</th>
                        <th id="percent3">% Mês 3</th>
                        <th>% Curva</th>
                        <th>%Curva Ajustada</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let categories = [];
        let percentages = [];
        let ajustes = {};

        function updateChart() {
            const originalData = percentages;
            const adjustedData = categories.map((categoria, index) => {
                const originalPercent = percentages[index];
                const ajuste = ajustes[categoria];
                const adjustedValue = ajuste !== undefined ? originalPercent * parseFloat(ajuste) : originalPercent;
                return Number(adjustedValue.toFixed(2));
            });

            if (chartInstance) {
                chartInstance.data.datasets[0].data = originalData;
                chartInstance.data.datasets[1].data = adjustedData;
                chartInstance.update();
            } else {
                const ctx = document.getElementById('percentChart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: categories,
                        datasets: [
                            {
                                label: '% Curva Original',
                                data: originalData,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: '% Curva Ajustada',
                                data: adjustedData,
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Percentual (%)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Curva Proporcional por Categoria'
                            }
                        }
                    }
                });
                document.getElementById('percentChart').style.display = 'block';
            }
        }

        function processData() {
            const totalVolumeInput = document.getElementById('totalVolume').value;
            const fileInput = document.getElementById('excelFile').files[0];

            if (!totalVolumeInput || !fileInput) {
                alert('Por favor, insira o volume total e selecione um arquivo Excel.');
                return;
            }

            const totalVolume = parseFloat(totalVolumeInput);
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, dateNF: 'yyyy-mm-dd' });

                // Extrair meses únicos e ordenar
                const months = [...new Set(jsonData.map(row => {
                    const date = new Date(row.Data);
                    if (isNaN(date)) return null;
                    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                }).filter(Boolean))].sort();

                // Atualizar cabeçalhos e cards com nomes dos meses
                const monthNames = months.slice(0, 3).map(month => {
                    const [year, monthNum] = month.split('-');
                    const date = new Date(year, monthNum - 1);
                    return date.toLocaleString('pt-BR', { month: 'short', year: 'numeric' });
                });
                document.getElementById('month1').textContent = monthNames[0] || 'Mês 1';
                document.getElementById('month2').textContent = monthNames[1] || 'Mês 2';
                document.getElementById('month3').textContent = monthNames[2] || 'Mês 3';
                document.getElementById('percent1').textContent = `% ${monthNames[0] || 'Mês 1'}`;
                document.getElementById('percent2').textContent = `% ${monthNames[1] || 'Mês 2'}`;
                document.getElementById('percent3').textContent = `% ${monthNames[2] || 'Mês 3'}`;
                document.getElementById('cardMonth1').textContent = monthNames[0] || 'Mês 1';
                document.getElementById('cardMonth2').textContent = monthNames[1] || 'Mês 2';
                document.getElementById('cardMonth3').textContent = monthNames[2] || 'Mês 3';

                // Calcular totais por mês
                let totalVolumeMonth1 = 0, totalVolumeMonth2 = 0, totalVolumeMonth3 = 0;
                jsonData.forEach(row => {
                    const date = new Date(row.Data);
                    if (isNaN(date)) return;
                    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    const volume = parseInt(row.Volume) || 0;
                    if (monthYear === months[0]) totalVolumeMonth1 += volume;
                    else if (monthYear === months[1]) totalVolumeMonth2 += volume;
                    else if (monthYear === months[2]) totalVolumeMonth3 += volume;
                });

                // Atualizar cards com totais
                document.getElementById('totalMonth1').textContent = totalVolumeMonth1;
                document.getElementById('totalMonth2').textContent = totalVolumeMonth2;
                document.getElementById('totalMonth3').textContent = totalVolumeMonth3;
                document.getElementById('monthCards').style.display = 'flex';

                // Organizar dados por categoria e mês
                const categorizedData = jsonData.reduce((acc, row) => {
                    const date = new Date(row.Data);
                    if (isNaN(date)) return acc;
                    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    const categoria = row.Categoria;
                    const volume = parseInt(row.Volume) || 0;

                    if (!acc[categoria]) {
                        acc[categoria] = { volumes: {} };
                    }
                    acc[categoria].volumes[monthYear] = volume;
                    return acc;
                }, {});

                // Gerar tabela
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                categories = [];
                percentages = [];
                ajustes = {};

                // Ordenar categorias
                const sortedCategories = Object.keys(categorizedData).sort((a, b) =>
                    a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
                );

                sortedCategories.forEach(categoria => {
                    const volumes = months.slice(0, 3).map(month =>
                        categorizedData[categoria].volumes[month] || 0
                    );
                    const percentagesMonth = volumes.map((volume, index) => {
                        if (volume === 0) return 0;
                        const total = index === 0 ? totalVolumeMonth1 : index === 1 ? totalVolumeMonth2 : totalVolumeMonth3;
                        return total > 0 ? Number(((volume / total) * 100).toFixed(2)) : 0;
                    });

                    // Calcular SOMARPRODUTO
                    const totalVolumesSum = totalVolumeMonth1 + totalVolumeMonth2 + totalVolumeMonth3;
                    const somarProduto = totalVolumesSum > 0 ? Number(
                        ((percentagesMonth[0] / 100) * volumes[0] +
                            (percentagesMonth[1] / 100) * volumes[1] +
                            (percentagesMonth[2] / 100) * volumes[2]) / (volumes[0] + volumes[1] + volumes[2]) * 100
                    ).toFixed(2) : 0;
                    console.log(percentagesMonth[0], percentagesMonth[1], percentagesMonth[2], totalVolumeMonth1, totalVolumeMonth2, totalVolumeMonth3, somarProduto, volumes);
                    categories.push(categoria);
                    percentages.push(Number(somarProduto));

                    const volume1 = volumes[0] ? volumes[0] : '0';
                    const volume2 = volumes[1] ? volumes[1] : '0';
                    const volume3 = volumes[2] ? volumes[2] : '0';

                    const row = `
                        <tr>
                            <td>${categoria}</td>
                            <td>${volume1}</td>
                            <td>${volume2}</td>
                            <td>${volume3}</td>
                            <td>${percentagesMonth[0]}%</td>
                            <td>${percentagesMonth[1]}%</td>
                            <td>${percentagesMonth[2]}%</td>
                            <td>${somarProduto}%</td>
                            <td><input type="number" step="0.1" class="form-control ajuste-input" data-categoria="${categoria}" placeholder="Ajuste" onchange="updateAjuste(this, '${categoria}')"></td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                document.getElementById('resultTable').style.display = 'table';
                updateChart();
            };

            reader.readAsArrayBuffer(fileInput);
        }

        function updateAjuste(input, categoria) {
            const value = input.value ? parseFloat(input.value) : undefined;
            ajustes[categoria] = value;
            updateChart();
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>