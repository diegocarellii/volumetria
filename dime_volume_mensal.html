<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WFM - Distribuição de Volume Mensal</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS para leitura/exportação de Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { padding: 20px; }
        .container { max-width: 1200px; }
        .card { margin-bottom: 20px; }
        .table { margin-top: 20px; }
        canvas { margin-top: 20px; }
        .percentage-input { width: 100px; text-align: center; }
        .summary { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">WFM - Distribuição de Volume Mensal</h1>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Volume Total do Mês</h5>
                <div class="mb-3">
                    <label for="monthlyVolume" class="form-label">Volume Total (ex.: chamadas):</label>
                    <input type="number" class="form-control" id="monthlyVolume" value="56000" min="0" onchange="updateTableAndChart()">
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Carregar Volumes Diários (3 Meses)</h5>
                <div class="mb-3">
                    <label for="excelFile" class="form-label">Selecione o arquivo Excel (.xlsx, Data, Volume, Categoria):</label>
                    <input type="file" class="form-control" id="excelFile" accept=".xlsx" onchange="handleExcelUpload()">
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Gráfico de Volume Diário</h5>
                <canvas id="volumeChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Distribuição por Dia</h5>
                <div class="mb-3">
                    <label for="monthYear" class="form-label">Selecione o Mês/Ano:</label>
                    <input type="month" class="form-control" id="monthYear" value="2025-04" onchange="updateTableAndChart()">
                </div>
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Porcentagem (%)</th>
                            <th>Volume Diário</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                    <tfoot>
                        <tr>
                            <td class="summary">Total</td>
                            <td class="summary" id="totalPercentage">0.0%</td>
                            <td class="summary" id="totalVolume">0</td>
                        </tr>
                    </tfoot>
                </table>
                <button class="btn btn-primary mt-3" onclick="updateTableAndChart()">Atualizar Tabela e Gráfico</button>
                <button class="btn btn-secondary mt-3 ms-2" onclick="exportToExcel()">Exportar para Excel</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Gerar categorias (ex.: "1 - qua", "1 - qui", etc.) para o mês selecionado
        function getCategoriesInMonth(year, month) {
            const categories = [];
            const lastDay = new Date(year, month, 0).getDate();
            const weekdays = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'];
            const weekCounts = { dom: 0, seg: 0, ter: 0, qua: 0, qui: 0, sex: 0, sab: 0 };

            for (let day = 1; day <= lastDay; day++) {
                const date = new Date(year, month - 1, day);
                const weekday = weekdays[date.getDay()];
                weekCounts[weekday]++;
                categories.push({ category: `${weekCounts[weekday]} - ${weekday}`, day });
            }
            return categories;
        }

        // Inicializar variáveis
        let categories = getCategoriesInMonth(2025, 4);
        let globalPercentages = new Array(categories.length).fill(0);
        let monthlyVolume = 56000;
        let excelData = null;

        // Inicializar gráfico
        const ctx = document.getElementById('volumeChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: categories.map(c => c.category),
                datasets: [{
                    label: 'Volume Diário',
                    data: new Array(categories.length).fill(0),
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: false,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Volume' },
                        ticks: { stepSize: 1000 }
                    },
                    x: {
                        title: { display: true, text: 'Categoria' },
                        ticks: { maxRotation: 45, minRotation: 45 }
                    }
                }
            }
        });

        // Função para ler arquivo Excel
        function readExcel(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: false, raw: true });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet, { raw: false, dateNF: 'dd/mm/yyyy' });

                console.log("Dados lidos do Excel:", json);

                if (!json[0] || !json[0].Data || json[0].Volume === undefined || !json[0].Categoria) {
                    alert('Arquivo Excel inválido! Esperado: colunas "Data" (DD/MM/YYYY), "Volume" e "Categoria".');
                    return;
                }

                // Processar dados
                const dataMap = {};
                json.forEach(row => {
                    const dateStr = row.Data instanceof Date ? row.Data.toLocaleDateString('pt-BR') : String(row.Data); // Ensure it's a string
                    const volume = parseFloat(row.Volume) || 0;
                    const category = row.Categoria.trim(); // Ex.: "1 - qua"

                    // Parsear a data
                    const dateParts = dateStr.split('/'); // Now safe to split
                    const day = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]);
                    const year = parseInt(dateParts[2]);

                    if (isNaN(day) || isNaN(month) || isNaN(year) || volume < 0) {
                        console.warn(`Data ou volume inválido: Data=${dateStr}, Volume=${volume}, Categoria=${category}`);
                        return;
                    }

                    const monthKey = `${year}-${month}`; // Ex.: "2025-1"
                    if (!dataMap[monthKey]) {
                        dataMap[monthKey] = {};
                    }
                    if (!dataMap[monthKey][category]) {
                        dataMap[monthKey][category] = 0;
                    }
                    dataMap[monthKey][category] += volume;
                });

                console.log("Dados organizados por mês e categoria:", dataMap);

                // Identificar os 3 meses mais recentes
                const months = Object.keys(dataMap)
                    .map(key => {
                        const [year, month] = key.split('-').map(Number);
                        return new Date(year, month - 1);
                    })
                    .sort((a, b) => b - a)
                    .slice(0, 3);

                if (months.length < 3) {
                    alert('Dados insuficientes! É necessário ter dados de pelo menos 3 meses.');
                    return;
                }

                // Organizar dados para os 3 meses mais recentes
                const monthKeys = months.map(date => `${date.getFullYear()}-${date.getMonth() + 1}`);
                const processedData = {};
                const allCategories = [...new Set(Object.values(dataMap).flatMap(month => Object.keys(month)))];
                allCategories.forEach(category => {
                    processedData[category] = {
                        vol1: dataMap[monthKeys[2]]?.[category] || 0,
                        vol2: dataMap[monthKeys[1]]?.[category] || 0,
                        vol3: dataMap[monthKeys[0]]?.[category] || 0
                    };
                });

                // Calcular totais mensais
                const monthlyTotals = [0, 0, 0];
                monthKeys.forEach((monthKey, index) => {
                    const monthData = dataMap[monthKey] || {};
                    monthlyTotals[index] = Object.values(monthData).reduce((sum, vol) => sum + vol, 0);
                });

                // Adicionar totais mensais ao processedData para uso posterior
                processedData.monthlyTotals = monthlyTotals;

                console.log("Dados processados (vol1, vol2, vol3):", processedData);
                callback(processedData);
            };
            reader.onerror = function(e) {
                alert('Erro ao ler o arquivo Excel: ' + e.message);
            };
            reader.readAsArrayBuffer(file);
        }

        // Função para calcular porcentagens a partir dos volumesSTE
        function calculatePercentages(data, categoryList) {
            const monthlyTotals = data.monthlyTotals;
            delete data.monthlyTotals; // Remover totais mensais do objeto de dados

            // Calcular proporcional de cada categoria em relação ao total do mês
            const proportionals = {};
            Object.keys(data).forEach(category => {
                const vol1 = data[category].vol1 || 0;
                const vol2 = data[category].vol2 || 0;
                const vol3 = data[category].vol3 || 0;
                proportionals[category] = {
                    prop1: monthlyTotals[0] > 0 ? (vol1 / monthlyTotals[0]) * 100 : 0,
                    prop2: monthlyTotals[1] > 0 ? (vol2 / monthlyTotals[1]) * 100 : 0,
                    prop3: monthlyTotals[2] > 0 ? (vol3 / monthlyTotals[2]) * 100 : 0
                };
            });

            console.log("Proporcionais por categoria:", proportionals);

            // Calcular proporcional ajustado por categoria (SOMARPRODUTO)
            const percentages = new Array(categoryList.length).fill(0);
            categoryList.forEach((catObj, index) => {
                const category = catObj.category;
                if (data[category] && proportionals[category]) {
                    const vol1 = data[category].vol1 || 0;
                    const vol2 = data[category].vol2 || 0;
                    const vol3 = data[category].vol3 || 0;
                    const totalVolumeCat = vol1 + vol2 + vol3;
                    if (totalVolumeCat > 0) {
                        const weightedSum = (vol1 * proportionals[category].prop1) + (vol2 * proportionals[category].prop2) + (vol3 * proportionals[category].prop3);
                        percentages[index] = (weightedSum / totalVolumeCat);
                    }
                }
            });

            // Normalizar para que a soma seja 100%
            const totalPercentage = percentages.reduce((sum, val) => sum + val, 0);
            if (totalPercentage > 0) {
                for (let i = 0; i < percentages.length; i++) {
                    percentages[i] = (percentages[i] / totalPercentage) * 100;
                }
            }

            console.log("Porcentagens calculadas:", percentages);
            return percentages;
        }

        // Função para lidar com upload do Excel
        function handleExcelUpload() {
            const excelFile = document.getElementById('excelFile').files[0];
            if (!excelFile) {
                alert('Por favor, selecione um arquivo Excel.');
                return;
            }

            readExcel(excelFile, (data) => {
                excelData = data;
                globalPercentages = calculatePercentages(excelData, categories);
                renderTableAndChart();
            });
        }

        // Função para atualizar tabela e gráfico
        function updateTableAndChart() {
            const monthYearInput = document.getElementById('monthYear').value;
            const [year, month] = monthYearInput.split('-').map(Number);
            categories = getCategoriesInMonth(year, month);
            monthlyVolume = parseFloat(document.getElementById('monthlyVolume').value) || 0;

            // Recalcular porcentagens se Excel já foi carregado
            if (excelData) {
                globalPercentages = calculatePercentages(excelData, categories);
            } else {
                globalPercentages = new Array(categories.length).fill(0);
            }

            renderTableAndChart();
        }

        // Função para renderizar tabela e gráfico
        function renderTableAndChart() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            let totalPercentage = 0;
            const dailyVolumes = globalPercentages.map(percentage => Math.round((monthlyVolume * percentage) / 100));
            const totalVolume = dailyVolumes.reduce((sum, v) => sum + v, 0);

            categories.forEach((catObj, index) => {
                totalPercentage += globalPercentages[index];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${catObj.category}</td>
                    <td><input type="number" class="percentage-input" id="percentage_${index}" value="${globalPercentages[index].toFixed(1)}" min="0" step="0.1" onchange="updatePercentage(${index})"></td>
                    <td id="volume_${index}">${dailyVolumes[index]}</td>
                `;
                tableBody.appendChild(row);
            });

            // Atualizar totais
            document.getElementById('totalPercentage').textContent = `${totalPercentage.toFixed(1)}%`;
            document.getElementById('totalVolume').textContent = totalVolume;
            if (Math.abs(totalPercentage - 100) > 0.1) {
                document.getElementById('totalPercentage').style.color = 'red';
            } else {
                document.getElementById('totalPercentage').style.color = 'black';
            }

            // Atualizar gráfico
            chart.data.labels = categories.map(c => c.category);
            chart.data.datasets[0].data = dailyVolumes;
            chart.update();
        }

        // Função para atualizar porcentagem
        function updatePercentage(index) {
            const percentageInput = document.getElementById(`percentage_${index}`);
            globalPercentages[index] = parseFloat(percentageInput.value) || 0;
            renderTableAndChart();
        }

        // Função para exportar para Excel
        function exportToExcel() {
            const dailyVolumes = percentages.map(percentage => Math.round((monthlyVolume * percentage) / 100));
            const data = categories.map((catObj, index) => ({
                Categoria: catObj.category,
                Porcentagem: percentages[index],
                VolumeDiario: dailyVolumes[index]
            }));

            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Distribuicao');
            XLSX.writeFile(workbook, 'distribuicao_volume_mensal.xlsx');
        }

        // Inicializar tabela e gráfico
        updateTableAndChart();
    </script>
</body>
</html>